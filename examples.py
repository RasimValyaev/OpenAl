from text_extractor import TextExtractor
import json

def test_model():
    print("1. Создание и обучение модели...")
    extractor = TextExtractor()
    
    # Дополнительные обучающие данные
    training_data = [
        (
            """
            Счет №123-45 от 15.03.2024
            По договору №ДП-2024/03 от 01.03.2024
            За поставку канцтоваров согласно накладной №ТН-789
            Сумма НДС: 1250.50 руб.
            За период 03.2024
            """,
            {
                "за_что": "поставка канцтоваров",
                "номер_договора": "ДП-2024/03",
                "номер_счета": "123-45",
                "номер_накладной": "ТН-789",
                "номер_заказа": ""
            }
        ),
        (
            """
            Оплата по заказу №Order-456 
            от 20.03.2024
            НДС не облагается
            """,
            {
                "за_что": "оплата по заказу",
                "номер_договора": "",
                "номер_счета": "",
                "номер_накладной": "",
                "номер_заказа": "Order-456"
            }
        ),
        (
            """
            Счет-фактура №789 от 10.03.2024
            по договору поставки №2024-ABC
            За оказание консультационных услуг
            Сумма НДС (20%): 45890.00
            Период оказания услуг: январь 2024
            """,
            {
                "за_что": "консультационные услуги",
                "номер_договора": "2024-ABC",
                "номер_счета": "789",
                "номер_накладной": "",
                "номер_заказа": ""
            }
        )
    ]
    
    # Обучаем модель
    extractor.train(training_data)
    
    # Сохраняем модель
    print("2. Сохранение модели...")
    extractor.save_model('text_extractor_model.pkl')
    
    # Загружаем модель
    print("3. Загрузка модели...")
    loaded_extractor = TextExtractor.load_model('text_extractor_model.pkl')
    
    # Тестовые примеры
    test_texts = [
        """
        Счет №456-78 от 25.03.2024
        По договору №КУ-2024/89
        За оказание юридических услуг
        Сумма НДС: 12800.00 руб.
        Период оказания услуг: март 2024
        """,
        
        """
        Оплата по накладной №ТН-2024-123
        от 22.03.2024 согласно заказу №789-Z
        НДС: 3600.50
        """,
        
        """
        По договору №АБВ/2024 от 18.03.2024
        За поставку оборудования
        Счет №12345 от 19.03.2024
        НДС не облагается
        Период: 03.2024
        """
    ]
    
    print("\n4. Тестирование модели на новых данных:")
    for i, text in enumerate(test_texts, 1):
        print(f"\nПример {i}:")
        print("-" * 50)
        print(f"Исходный текст:\n{text.strip()}")
        print("\nРезультат обработки:")
        
        result = loaded_extractor.extract_from_text(text)
        print(json.dumps(result, ensure_ascii=False, indent=2))
        print("-" * 50)

if __name__ == "__main__":
    test_model()